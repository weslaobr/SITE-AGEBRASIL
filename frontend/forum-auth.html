<!DOCTYPE html>
<html lang="pt-BR">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Autenticando... - Age of Empires IV Brasil</title>
    <style>
        body {
            background-color: #1a202c;
            color: white;
            font-family: sans-serif;
            display: flex;
            align-items: center;
            justify-content: center;
            height: 100vh;
            margin: 0;
            text-align: center;
        }

        .loader {
            border: 4px solid #f3f3f3;
            border-top: 4px solid #ecc94b;
            border-radius: 50%;
            width: 40px;
            height: 40px;
            animation: spin 1s linear infinite;
            margin: 0 auto 1rem;
        }

        @keyframes spin {
            0% {
                transform: rotate(0deg);
            }

            100% {
                transform: rotate(360deg);
            }
        }
    </style>
</head>

<body>
    <div>
        <div class="loader"></div>
        <h2>Conectando com Discord...</h2>
        <p id="status">Aguarde um momento.</p>
    </div>

    <script>
        const API_BASE_URL = window.location.hostname === 'localhost' || window.location.hostname === '127.0.0.1'
            ? 'http://localhost:3001/api'
            : '/api';

        async function handleCallback() {
            const urlParams = new URLSearchParams(window.location.search);
            const code = urlParams.get('code');
            const error = urlParams.get('error');

            if (error) {
                document.getElementById('status').textContent = 'Erro na autenticação: ' + error;
                setTimeout(() => window.location.href = 'forum.html', 3000);
                return;
            }

            if (!code) {
                window.location.href = 'forum.html';
                return;
            }

            try {
                const response = await fetch(`${API_BASE_URL}/auth/discord`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify({ code })
                });

                if (!response.ok) {
                    const errData = await response.json().catch(() => ({}));
                    throw new Error(errData.error || `Falha ao trocar token (${response.status})`);
                }

                const data = await response.json();

                // Salvar sessão
                localStorage.setItem('forum_token', data.token.access_token);
                localStorage.setItem('forum_user', JSON.stringify(data.user));

                document.getElementById('status').textContent = 'Sucesso! Redirecionando...';
                setTimeout(() => window.location.href = 'forum.html', 1000);

            } catch (err) {
                console.error(err);
                document.getElementById('status').innerHTML = `<span style="color: #fc8181;">Erro: ${err.message}</span><br><span style="font-size: 0.8rem; color: #a0aec0;">Verifique o console (F12) para mais detalhes.</span>`;
                // setTimeout(() => window.location.href = 'forum.html', 5000);
            }
        }

        handleCallback();
    </script>
</body>

</html>